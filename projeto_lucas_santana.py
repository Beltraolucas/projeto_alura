# -*- coding: utf-8 -*-
"""Projeto_Lucas_Santana.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1DOGxFwS5xM9_t1oZp9V4geAzHSCJP7lZ
"""

# Commented out IPython magic to ensure Python compatibility.
# %pip -q install google-genai

# Configura a API Key do Google Gemini

import os
from google.colab import userdata

os.environ["GOOGLE_API_KEY"] = userdata.get('GOOGLE_API_KEY')

# Configura o cliente da SDK do Gemini

from google import genai

client = genai.Client()

MODEL_ID = "gemini-2.0-flash"

# Instalar Framework de agentes do Google ################################################
!pip install -q google-adk

from google.adk.agents import Agent
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService
from google.adk.tools import google_search
from google.genai import types  # Para criar conteÃºdos (Content e Part)
from datetime import date
import textwrap # Para formatar melhor a saÃ­da de texto
from IPython.display import display, Markdown # Para exibir texto formatado no Colab
import requests # Para fazer requisiÃ§Ãµes HTTP
import warnings

warnings.filterwarnings("ignore")

# FunÃ§Ã£o auxiliar que envia uma mensagem para um agente via Runner e retorna a resposta final
def call_agent(agent: Agent, message_text: str) -> str:
    # Cria um serviÃ§o de sessÃ£o em memÃ³ria
    session_service = InMemorySessionService()
    # Cria uma nova sessÃ£o (vocÃª pode personalizar os IDs conforme necessÃ¡rio)
    session = session_service.create_session(app_name=agent.name, user_id="user1", session_id="session1")
    # Cria um Runner para o agente
    runner = Runner(agent=agent, app_name=agent.name, session_service=session_service)
    # Cria o conteÃºdo da mensagem de entrada
    content = types.Content(role="user", parts=[types.Part(text=message_text)])

    final_response = ""
    # Itera assincronamente pelos eventos retornados durante a execuÃ§Ã£o do agente
    for event in runner.run(user_id="user1", session_id="session1", new_message=content):
        if event.is_final_response():
          for part in event.content.parts:
            if part.text is not None:
              final_response += part.text
              final_response += "\n"
    return final_response

# FunÃ§Ã£o auxiliar para exibir texto formatado em Markdown no Colab
def to_markdown(text):
  text = text.replace('â€¢', '  *')
  return Markdown(textwrap.indent(text, '> ', predicate=lambda _: True))

#################################
# --- Agente 1: Organizador --- #
#################################
def agente_organizador(itens_solicitados):

    organizador = Agent(
        name="agente_organizador",
        model="gemini-2.0-flash",
        instruction="""
        VocÃª Ã© um assitente de um materiais de construÃ§Ã£o. A sua tarefa Ã© criar uma tabela com os itens solicitados.
        A formataÃ§Ã£o da tabela deve ser da seguinte maneira: a primeira coluna representa o nÃºmero do item solicitado,
        a segunda coluna terÃ¡ como tÃ­tulo "referÃªncia" mas ficarÃ¡ vazia por enquanto, a terceira coluna o nome do item solicitado,
        a quarta coluna a unidade da quantidade solicitada, a quinta coluna a quantidade solicitada, a sexta coluna valor unitÃ¡rio
        mas ficarÃ¡ vazia por enquanto e a sÃ©tima coluna terÃ¡ o tÃ­tulo de valor total mas ficarÃ¡ fazia por enquanto.
        Lembre-se que a resposta deve ser formatada como uma tabela.
        Por exemplo:
        #####
        Gostaria de um orÃ§amento de dois sacos de cimento, 1 metro cÃºbico de areia, 2 metros de fio elÃ©trico, 50 tijolo cerÃ¢mico, 1 tinta acrÃ­lica, 10 metros de tubo de PVC, 4 conexÃµes de PVC e 2 metros de eletroduto corrugado.
        Espero que a sua resposta seja da seguinte maneira, sÃ³ que fomatado como uma tabela:
        NÃºmero do item, ReferÃªncia, Nome do item, Unidade, Quantidade, Valor unitÃ¡rio, Valor total
        1, , Cimento, kg, 2, ,
        2, , Areia, m3, 1, ,
        3, , Fio elÃ©trico, m, 2, ,
        4, , tijolo cerÃ¢mico, Un, 50, ,
        5, , tinta acrÃ­lica, Lata, 1, ,
        6, , tubo de PVC, m, 10, ,
        7, , conexÃµes de PVC, Un, 4, ,
        8, , Eletroduto corrugado, m, 2, ,
        #####
        """,
        description="Agente que organiza a solicitaÃ§Ã£o",
    )

    entrada_do_agente_organizador = itens_solicitados

    tabela_organizada = call_agent(organizador, entrada_do_agente_organizador)
    return tabela_organizada

################################
# --- Agente 2: Financeiro --- #
################################
def agente_financeiro(tabela_apos_organizacao):
    calculador = Agent(
        name="agente_financeiro",
        model="gemini-2.0-flash",
        instruction="""
        VocÃª Ã© um assistente de um vendedor de um materiais de construÃ§Ã£o.
Â  Â  Â  Â  VocÃª tem como referÃªncia a seguinte tabela:

Â  Â  Â  Â  ####
Â  Â  Â  Â  ReferÃªncia, Nome do Item, Unidade, Valor initÃ¡rio (R$)
Â  Â  Â  Â  1, Areia, Metro cÃºbico, 50
Â  Â  Â  Â  2, Argamassa, Pacote de 20kg, 20
Â  Â  Â  Â  3, Bloco de concreto, Unidade, 1
Â  Â  Â  Â  4, Brita, Metro cÃºbico, 40
Â  Â  Â  Â  5, Caixa de passagem (elÃ©tricas), Unidade, 5
Â  Â  Â  Â  6, Cal, Pacote de 20kg, 15
Â  Â  Â  Â  7, Cimento, Pacote de 50kg, 25
Â  Â  Â  Â  8, Disjuntor, Unidade, 10
Â  Â  Â  Â  9, Eletroduto corrugado, Metro, 5
Â  Â  Â  Â  10, Fio elÃ©trico, Metro, 2
Â  Â  Â  Â  11, LÃ¢mpadas (LED), Unidade, 10
Â  Â  Â  Â  12, Piso cerÃ¢mico, Metro quadrado, 50
Â  Â  Â  Â  13, Porcelanato, Metro quadrado, 100
Â  Â  Â  Â  14, SifÃ£o flexÃ­vel, Unidade, 10
Â  Â  Â  Â  15, Telha de fibrocimento, Unidade, 50
Â  Â  Â  Â  16, Tinta acrÃ­lica, Unidade, 80
Â  Â  Â  Â  17, Tijolo cerÃ¢mico, Unidade, 0.50
Â  Â  Â  Â  18, Tubo de PVC, Metro, 5
Â  Â  Â  Â  19, ConexÃ£o de PVC, Unidade, 5
Â  Â  Â  Â  20, VergalhÃ£o de aÃ§o, Unidade, 10
Â  Â  Â  Â  ####

        VocÃª receberÃ¡ uma tabela com os itens solicitados, mas qua ainda nÃ£o estÃ¡ completamente preenchida.
        Seu papel Ã© completar os campos em branco dessa tabela em funÃ§Ã£o dos itens solicitados, usando como referÃªncia sua tabela de referÃªncia.
        A Ãºltima coluna consistirÃ¡ da multiplicaÃ§Ã£o da coluna "Quantidade" pela coluna "Valor unitÃ¡rio".
Â  Â  Â  Â  Caso exista um Nome do item que nÃ£o pertence a sua tabela de referÃªncia, avise que nÃ£o trabalhamos com esse item e exclua a linha da tabela.
        Lembre-se de considerar provÃ¡veis erros de digitaÃ§Ã£o.
        Lembre-se tambÃ©m de manter a formataÃ§Ã£o da tabela que vocÃª recebeu.
        Por exemplo:
        #####
        VocÃª recebeu a seguinte tabela:
        NÃºmero do item, ReferÃªncia, Nome do item, Unidade, Quantidade, Valor unitÃ¡rio, Valor total
        1, , Cimento, kg, 2, ,
        2, , Areia, m3, 1, ,
        3, , Fio elÃ©trico, m, 2, ,
        4, , tijolo cerÃ¢mico, Un, 50, ,
        5, , tinta acrÃ­lica, Lata, 1, ,
        6, , tubo de PVC, m, 10, ,
        7, , conexÃµes de PVC, Un, 4, ,
        8, , Eletroduto corrugado, m, 2, ,
        Eu espero que vocÃª devolva a seguinte tabela:
        NÃºmero do item, ReferÃªncia, Nome do item, Unidade, Quantidade, Valor unitÃ¡rio, Valor total
        1, 7, Cimento, kg, 2, 25, 50
        2, 1, Areia, m3, 1, 50, 50
        3, 10, Fio elÃ©trico, m, 2, 2, 4
        4, 17, tijolo cerÃ¢mico, Un, 50, 0.50, 25
        5, 16, tinta acrÃ­lica, Lata, 1, 80, 80
        6, 18, tubo de PVC, m, 10, 5, 50
        7, 19, conexÃµes de PVC, Un, 4, 5, 20
        8, 9, Eletroduto corrugado, m, 2, 5, 10
        #####
        """,
        description="Agente que calcula o valor dos intens solicitados",
        tools=[google_search]
    )

    entrada_do_agente_financeiro = tabela_apos_organizacao
    # Executa o agente
    tabela_financeira = call_agent(calculador, entrada_do_agente_financeiro)
    return tabela_financeira

##########################################
# --- Agente 3: Revisor de Qualidade --- #
##########################################
def agente_revisor(tabela_antes_da_revisao):
    revisor = Agent(
        name="agente_revisor",
        model="gemini-2.0-flash",
        instruction="""
            VocÃª Ã© um assistente do setor de vendas de um material de contruÃ§Ã£o, seu objetivo e verificar coerencia dos orÃ§amentos que vocÃª recebe.
            VocÃª receberÃ¡ um tabela e deve verificar se todas as linhas estÃ£o preenchidas.
            Caso vocÃª encontre o alguma linha da coluna "ReferÃªncia" vazia, vocÃª deve avisar que nÃ£o trabalhamos com o item solicitado.
            Caso isso aconteÃ§a, exclua as linhas com a coluna "ReferÃªncia" vazia.
            AlÃ©m disso, vocÃª deve adicionar uma nova linha na parte inferior da tabela com o valor total da compra.
            Lembre-se de mostrar a tabela completa com as modificaÃ§Ãµes.
            """,
        description="Agente revisor de orÃ§amentos."
    )
    entrada_do_agente_revisor = tabela_antes_da_revisao
    # Executa o agente
    orcamento_revisado = call_agent(revisor, entrada_do_agente_revisor)
    return orcamento_revisado

print("ğŸš€ Iniciando o Sistema de CriaÃ§Ã£o de OrÃ§amentos com 3 Agentes ğŸš€")

# --- Obter o TÃ³pico do UsuÃ¡rio ---
itens_solicitados = input("â“ Por favor, digite os itens que vocÃª gostaria de incluir no orÃ§amento: ")

# Inserir lÃ³gica do sistema de agentes ################################################
if not itens_solicitados:
    print("VocÃª esqueceu de digitar os itens!")
else:
    print("Maravilha! Vamos montar seu orÃ§amento.")

    resultado_da_organizacao = agente_organizador(itens_solicitados)
    print("\n--- ğŸ“ Resultado do Agente 1 (Organizador) ---\n")
    display(to_markdown(resultado_da_organizacao))
    print("--------------------------------------------------------------")

    previa_do_orcamento = agente_financeiro(resultado_da_organizacao)
    print("\n--- ğŸ“ Resultado do Agente 2 (Financeiro) ---\n")
    display(to_markdown(previa_do_orcamento))
    print("--------------------------------------------------------------")

    orcamento = agente_revisor(previa_do_orcamento)
    print("\n--- ğŸ“ Resultado do Agente 3 (Revisor) ---\n")
    display(to_markdown(orcamento))
    print("--------------------------------------------------------------")